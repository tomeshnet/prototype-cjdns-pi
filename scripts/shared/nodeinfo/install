#!/usr/bin/env bash

set -e

LAST_BASE="$BASE_DIR"
BASE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

cp $BASE_DIR/nodeinfo.json /tmp

# Replace placeholders with dynamic info
sed -i -e "s/REPO/$(git remote get-url origin | awk -F / '{print $5}'| cut -d '.' -f1)/g" /tmp/nodeinfo.json
sed -i -e "s/BRANCH/$(git rev-parse --abbrev-ref HEAD)/g" /tmp/nodeinfo.json
sed -i -e "s/COMMIT/$(git rev-parse HEAD)/g" /tmp/nodeinfo.json
sed -i -e "s/INSTALLED/$(date)/g" /tmp/nodeinfo.json

sed -i -e "s/KEY/$(grep -m 1 '"ipv6"' /etc/cjdroute.conf | awk '{ print $2 }' | sed 's/[",]//g')/g" /tmp/nodeinfo.json
sed -i -e "s/ORG/$MESH_NAME/g" /tmp/nodeinfo.json

# Only adding IPFS for now, more to come later
if [[ "$SUPPORT_IPFS" == "true" ]] && [ ! -z "$WITH_IPFS" -a "$WITH_IPFS" == "true" ]; then
        sed -i -e 's/SERVICES/"ipfs":{"version":"'"$(ipfs --version | awk '{ print $3 }')"'","ID":'"$(ipfs id | jq '.ID')}"/g /tmp/nodeinfo.json
else
    sed -i -e 's/SERVICES//g' /tmp/nodeinfo.json # Leave it empty
fi

BASE_DIR="$LAST_BASE"
 
sudo cp /tmp/nodeinfo.json /var/www/html
