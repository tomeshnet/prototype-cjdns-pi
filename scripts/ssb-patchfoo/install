#!/bin/bash
# shellcheck disable=SC1091
true

BASE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

CURRENT_DIR="$(pwd)"

sleep 5
# shellcheck disable=SC2164
cd ~/.ssb/node_modules

# Install dependencies
npm install asyncmemo hashlru pull-stream pull-cat multicb hyperscript pull-paramap ssb-contact ssb-sort stream-to-pull-stream emoji-server pull-paginate ssb-mentions busboy mime-types pull-identify-filetype human-time pull-hyperscript jpeg-autorotate pull-catch diff pull-split pull-utf8-decoder ssb-web-resolver highlight.js pull-box-stream base64-url ssb-backlinks ssb-private

# Install patchfoo and enable plugin
git clone https://github.com/ssbc/patchfoo.git patchfoo
sbot plugins.install ssb-private
sbot plugins.install ssb-backlinks
sbot plugins.enable patchfoo

# Stop ssb service to process plugin
sudo systemctl stop ssb

# Disable the git-ssb prerequisite
# Comment out two lines in patchwork that create a prerequisite for git-ssb
# but don't seem to serve any purpose. Git-ssb is not available on npm
sed -i 's#var Git#//var Git#' patchfoo/lib/app.js  patchfoo/lib/app.js
sed -i 's#this.git = new Git(this.sbot, this.config)#//this.git = new Git(this.sbot, this.config)#' patchfoo/lib/app.js

# Start service again to start patchfoo
sudo systemctl start ssb

# Install nginx reverse proxy file
sudo cp "$BASE_DIR/ssb-patchfoo.conf" /etc/nginx/site-path-enabled/ssb-patchfoo.conf

# Add entry into nginx home screen
APP="<div class='app'><h2>Patch Foo</h2>Plain SSB web UI. <br/><a href='/patchfoo'>Go</a></div>"
sudo sed -i "s#<\!--APPLIST-->#$APP\n<\!--APPLIST-->#" "/var/www/html/index.html"

# shellcheck disable=SC2164
cd "$CURRENT_DIR"
